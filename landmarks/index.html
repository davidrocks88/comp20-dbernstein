<!DOCTYPE html>

<html>

        <head>
                <title>Landmarks</title>
                <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
                <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?sensor=true"></script>
                <link rel="stylesheet" href="geolocation_map_style.css" />
                
                <script>
                        myLat = 0;
                        myLng = 0;
                        var me = new google.maps.LatLng(myLat, myLng);
                        var myOptions = {
                                                zoom: 13, // The larger the zoom number, the bigger the zoom
                                                center: me,
                                                mapTypeId: google.maps.MapTypeId.ROADMAP
                                        };
                        var map;
                        var marker;
                        var infowindow = new google.maps.InfoWindow();
                        
                        function init()
                        {
                                map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
                                getMyLocation();
                        }
                        
                        function getMyLocation() {
                                if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
                                        navigator.geolocation.getCurrentPosition(function(position) {
                                                myLat = position.coords.latitude;
                                                myLng = position.coords.longitude;
                                                renderMap();
                                        });
                                }
                                else {
                                        alert("Geolocation is not supported by your web browser.  What a shame!");
                                }
                        }

                        function renderMap() {
                                me = new google.maps.LatLng(myLat, myLng);

                                // Update map and go there...
                                map.panTo(me);
        
                                // Create a marker
                                marker = new google.maps.Marker({
                                        position: me,
                                        title: "Here I Am!"
                                });
                                marker.setMap(map);
                                addMarkers();
                                        
                                // Open info window on click of marker
                                google.maps.event.addListener(marker, 'click', function() {
                                        infowindow.setContent(marker.title);
                                        infowindow.open(map, marker);
                                });
                        }

                        function addMarkers() {
                                var login = "MOISES_MCBRIDE";
                                var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
                                var request = new XMLHttpRequest();

                                sendData = "login="+login+"&lat="+ myLat +"&lng="+ myLng;

                                request.open("POST", url, true);
                                request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                                request.onreadystatechange = function() {
                                        if (request.readyState == 4 && request.status == 200) {
                                                console.log("Got the data back!");
                                                data = JSON.parse(request.responseText);
                                                // console.log(data);
                                                doStuff(data);
                                        }
                                        else if (request.readyState == 4 && request.status != 200) {
                                            console.log("got bad status code");
                                        }
                                        else {
                                                console.log("In progress...");
                                        }
                                };

                                request.send(sendData);
                        }

                        function doStuff(data) {
                                console.log("did stuff!");
                                console.log(data);
                                for(i = 0; i < data.landmarks.length; i++) {
                                        var lng = data.landmarks[i].geometry.coordinates[0];
                                        var lat = data.landmarks[i].geometry.coordinates[1];
                                        var name = data.landmarks[i].properties.Location_Name;



                                        var temp = new google.maps.LatLng(lat, lng)
                                        var tmarker = new google.maps.Marker({
                                                position: temp,
                                                title: name
                                        });
                                        tmarker.setMap(map);
                                        google.maps.event.addListener(tmarker, 'click', function() {
                                                infowindow.setContent(tmarker.title);
                                                infowindow.open(map, tmarker);
                                        });
                                }
                        }


                        function toRad(x) {
                                return x * Math.PI / 180;
                        }

                        function distance(lat1, lng1, lat2, lng2, isMiles) {
                                var R = 6371;

                                var x1 = lat2 - lat1;
                                var dLat = toRad(x1);

                                var x2 = lng2 - lng1;
                                var dLon = toRad(x2);

                                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                                var d = R * c;

                                if(isMiles) d /= 1.60934;

                                return d;
                        }
                </script>
        </head>
        
        <body onload="init()">
                <div id="map_canvas"></div>
        </body>
</html>